<%#
  This partial displays leave notifications for colleagues. It expects a local
  variable `alerts` which is an array of Issue records generated by the
  leave automator. Alerts are grouped by author so a colleague on leave
  spanning multiple days will only produce a single message showing the date
  range. Each alert has a dismiss button which hides the notification and
  records the dismissal date in localStorage. On subsequent page loads within
  the same day, previously dismissed alerts remain hidden; they reappear the
  next day. Styling is kept inline to avoid dependency on external CSS.
%>
<% alerts_by_author = alerts.group_by(&:author) %>
<div id="leave-alert-wrapper" style="margin-bottom:8px;">
  <% alerts_by_author.each do |author, issues| %>
    <% start_date = issues.map(&:start_date).min %>
    <% end_date   = issues.map(&:start_date).max %>
    <% issue_id  = issues.first.id %>
    <div id="leave-alert-<%= issue_id %>" class="leave-alert" style="background:#fff7e5;border:1px solid #f0e68c;padding:8px 32px 8px 8px;margin-bottom:4px;position:relative;font-size:13px;">
      <span>
        <strong><%= author.name %></strong>
        <%# Determine if the colleague is off for a single day or a range %>
        <% if start_date == end_date %>
          on leave on <%= start_date %>
        <% else %>
          on leave from <%= start_date %> đến <%= end_date %>
        <% end %>
      </span>
      <button type="button" style="position:absolute;right:6px;top:4px;background:none;border:none;color:#333;font-size:16px;line-height:1;cursor:pointer;" onclick="dismissLeaveAlert('<%= issue_id %>')">&times;</button>
    </div>
  <% end %>
</div>
<script>
// Records a dismissal in localStorage for the current day and hides the alert.
function dismissLeaveAlert(issueId) {
  var key = 'leave_alert_' + issueId;
  var today = new Date().toISOString().slice(0,10);
  try {
    localStorage.setItem(key, today);
  } catch (e) {}
  var el = document.getElementById('leave-alert-' + issueId);
  if (el) { el.style.display = 'none'; }
}

// On page load, hide alerts that were dismissed today. Alerts dismissed on
// previous days will reappear so colleagues are reminded again on subsequent
// days of the leave period.
(function() {
  var wrapper = document.getElementById('leave-alert-wrapper');
  if (!wrapper) return;
  var today = new Date().toISOString().slice(0,10);
  var alerts = wrapper.querySelectorAll('.leave-alert');
  for (var i = 0; i < alerts.length; i++) {
    var alertEl = alerts[i];
    var id = alertEl.id.replace('leave-alert-','');
    var key = 'leave_alert_' + id;
    try {
      var dismissedAt = localStorage.getItem(key);
      if (dismissedAt === today) {
        alertEl.style.display = 'none';
      }
    } catch (e) {}
  }
})();
</script>
